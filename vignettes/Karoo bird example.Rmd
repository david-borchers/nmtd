---
title: "Worked example: Karoo bird data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Worked example: Karoo bird data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


This vignette shows a worked example of how the `nmtd` package can be used to fit various models to data. As an example, we are using the `Karoodata` data set that comes with the package. See the helpfile for more information on this data set and its origin.

```{r setup}
library(nmtd)
library(tidyverse)
```

## Getting the data ready

We first load the data frame and have a quick look at it:

```{r}
data("Karoodata")
str(Karoodata)
names(Karoodata)
```

The data set consists of 10-minute bird counts carried out at points (`survey_id`) throughout the Karoo region in South Africa. All bird species that were seen or heard were noted down, along with the exact time at which the first individual of a species was encountered. A number of covariates were also recorded. Multiple point counts were carried out at each site (`pentad`), which are grid cells of 5' $\times$ 5' (longitude, latitude).

In total, there were `r length(unique(Karoodata$survey_id))` surveys to `r length(unique(Karoodata$pentad))` sites. Each site received between 10 and 20 surveys:

```{r}
nsurveys <- Karoodata %>%
  group_by(pentad) %>%
  summarise(surveys = length(unique(survey_id)))

hist(nsurveys$surveys, main = "", xlab = "Number of surveys")
```

For our purposes here, we choose a single species, the bokmakierie (*Telophorus zeylonus*), an attractive bushshrike that is quite common in the region. We need to aggregate our data so that we have one line per survey. For each survey, we need to know whether a bokmakierie was detected (variable `bokmakierie` in the code below: 1 if detected and 0 if not) and what the time to detection (`ttd`) was. If no bokmakierie was detected during the survey, we set `ttd` equal to the maximum, i.e. 660 seconds (recall that each survey lasted 10 minutes).

```{r}
# table(Karoodata$pentad, Karoodata$species)  # useful table to see how common each species is

# detections:
bdata <- Karoodata[Karoodata$species == "Bokmakierie", c("survey_id", "pentad", "ttd")]

# non-detections:
bdata.nd <- Karoodata[Karoodata$species != "Bokmakierie", c("survey_id", "pentad")]

# we only need one non-detection per survey
bdata.nd <- bdata.nd %>%
  group_by(survey_id) %>%
  summarise(pentad = first(pentad), ttd = 660)

bdata <- rbind(bdata, bdata.nd)

# get rid of non-detections for surveys where we also had a detection
bdata <- bdata %>%
  group_by(survey_id) %>%
  summarise(pentad = first(pentad), ttd = min(ttd))

head(bdata, n=20)
```

We now have a data frame with one line per survey. It gives the time to detection if a bokmakierie was detected and the maximum survey time otherwise. We now need to get this into the format that the function `nll.binT1` expects, with one row per site and the columns corresponding to the repeat surveys, holding detection times.

```{r}
bdata$surveynumber <- substr(bdata$survey_id, 11,12)

bdata_wide <- bdata[,-1] %>% 
  pivot_wider(
    names_from = surveynumber,
    values_from = ttd
  )

fit_binT1M <- optim(c(log(0.1), log(0.1)), nll.binT1M, R = dim(bdata_wide)[1], J = dim(bdata_wide)[2], Tmax = 660, dat = as.matrix(bdata_wide[,-1]))

```
