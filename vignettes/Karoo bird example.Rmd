---
title: "Worked example: Karoo bird data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Worked example: Karoo bird data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


This vignette shows a worked example of how the `nmtd` package can be used to fit various models to data. As an example, we are using the `Karoodata` data set that comes with the package. See the helpfile for more information on this data set and its origin.

```{r setup}
library(nmtd)
library(tidyverse)
```

## Getting the data ready

We first load the data frame and have a quick look at it:

```{r}
data("Karoodata")
str(Karoodata)
names(Karoodata)
```

The data set consists of 10-minute bird counts carried out at points (`survey_id`) throughout the Karoo region in South Africa. All bird species that were seen or heard were noted down, along with the exact time at which the first individual of a species was encountered. A number of covariates were also recorded. Multiple point counts were carried out at each site (`pentad`), which are grid cells of 5' $\times$ 5' (longitude, latitude).

In total, there were `r length(unique(Karoodata$survey_id))` surveys to `r length(unique(Karoodata$pentad))` sites. Each site received between 10 and 20 surveys:

```{r}
nsurveys <- Karoodata %>%
  group_by(pentad) %>%
  summarise(surveys = length(unique(survey_id)))

hist(nsurveys$surveys, main = "", xlab = "Number of surveys")
```

For our purposes here, we choose a single species, the bokmakierie (*Telophorus zeylonus*), an attractive bushshrike that is quite common in the region. 

We need to aggregate our data so that we have one line per survey. For each survey, we need to know whether a bokmakierie was detected (variable `bokmakierie` in the code below: 1 if detected and 0 if not) and what the time to detection (`ttd`) was. If no bokmakierie was detected during the survey, we set `ttd` equal to the maximum, i.e. 660 seconds (recall that each survey lasted 10 minutes).

```{r}
# table(Karoodata$pentad, Karoodata$species)  # useful table to see how common each species is

# detections:
bdata <- Karoodata[Karoodata$species == "Bokmakierie", c("survey_id", "pentad", "ttd")]

# non-detections:
bdata.nd <- Karoodata[Karoodata$species != "Bokmakierie", c("survey_id", "pentad")]

# we only need one non-detection per survey
bdata.nd <- bdata.nd %>%
  group_by(survey_id) %>%
  summarise(pentad = first(pentad), ttd = 660)

bdata <- rbind(bdata, bdata.nd)

# get rid of non-detections for surveys where we also had a detection
bdata <- bdata %>%
  group_by(survey_id) %>%
  summarise(pentad = first(pentad), ttd = min(ttd))

head(bdata, n=20)
```

We now have a data frame with one line per survey. It gives the time to detection if a bokmakierie was detected and the maximum survey time otherwise. We now need to get this into the format that the function `nll.binT1` expects, with one row per site and the columns corresponding to the repeat surveys, holding detection times.

```{r}
bdata_wide <- bdata[,-1] %>%
  group_by(pentad) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(names_from = row, values_from = ttd)

head(bdata_wide)
```

All sites have at least 10 visits but some sites have more. At the moment, the functions can only deal with a fixed number of visits to each site. We therefore take the first 10 visits to each site and discard the rest of the data.

While we are at it, we also prepare the input data for the model `Binary:M`, where we only use detections and non-detection, i.e. we discard the information on time to detection.

```{r}
bdata_ttd <- bdata_dnd <- bdata_wide[,2:11]
bdata_dnd[bdata_dnd < 660]  <- 1
bdata_dnd[bdata_dnd == 660]  <- 0
```

So, in this final data set, we have `r dim(bdata_ttd)[2]` surveys to `r dim(bdata_ttd)[1]` sites, i.e. `r dim(bdata_ttd)[2] * dim(bdata_ttd)[1]` surveys in total. Bokmakieries were detected on `r sum(bdata_dnd)` surveys at `r sum(apply(bdata_dnd, 1, max))` of the sites.

On most sites where bokmakieries were detected, they were encountered fairly early during the survey:

```{r, echo=F}
hist(bdata_ttd[bdata_ttd < 660], main = "", xlab = "Time to detection [s]")
```

We are now ready to fit the models to the data.

We first fit the model using time-to-detection data, `BinaryT1:M`:

```{r}
fit_binT1M <- optim(c(log(10), log(0.001)), nll.binT1M, R = dim(bdata_ttd)[1], J = dim(bdata_ttd)[2], Tmax = 660, dat = as.matrix(bdata_ttd))
estpar_binT1M=fit_binT1M$par
exp(estpar_binT1M)
```

Then, we fit the model using only detection / non-detection data, `Binary:M`:

```{r}
fit_binM <- optim(c(log(10), log(0.001)), nll.binM, R = dim(bdata_ttd)[1], J = dim(bdata_ttd)[2], Tmax = 660, dat = as.matrix(bdata_dnd))
estpar_binM=fit_binM$par
exp(estpar_binM)
```